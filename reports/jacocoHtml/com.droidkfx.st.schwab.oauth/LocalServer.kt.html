<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
    <link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/>
    <link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/>
    <title>LocalServer.kt</title>
    <link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/>
    <script type="text/javascript" src="../jacoco-resources/prettify.js"></script>
</head>
<body onload="window['PR_TAB_WIDTH']=4;prettyPrint()">
<div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html"
                                                              class="el_session">Sessions</a></span><a
        href="../index.html" class="el_report">schwab-trader</a> &gt; <a href="index.source.html" class="el_package">com.droidkfx.st.schwab.oauth</a>
    &gt; <span class="el_source">LocalServer.kt</span></div>
<h1>LocalServer.kt</h1>
<pre class="source lang-java linenums">package com.droidkfx.st.schwab.oauth

import com.droidkfx.st.config.CallbackServerConfig
import io.github.oshai.kotlinlogging.KotlinLogging.logger
import io.ktor.http.HttpStatusCode
import io.ktor.server.application.ApplicationStopped
import io.ktor.server.engine.ApplicationEngine
import io.ktor.server.engine.EmbeddedServer
import io.ktor.server.engine.embeddedServer
import io.ktor.server.engine.sslConnector
import io.ktor.server.html.respondHtml
import io.ktor.server.netty.Netty
import io.ktor.server.routing.get
import io.ktor.server.routing.routing
import kotlinx.coroutines.CompletableDeferred
import kotlinx.html.body
import kotlinx.html.h3
import kotlinx.html.head
import kotlinx.html.p
import kotlinx.html.span
import kotlinx.html.title
import java.io.File
import java.io.FileInputStream
import java.net.URLDecoder
import java.security.KeyStore


<span class="nc" id="L28">class LocalServer(</span>
<span class="nc" id="L29">    val callbackServerConfig: CallbackServerConfig</span>
) {
<span class="nc" id="L31">    data class Result(val code: String?, val session: String?, val state: String?, val error: String?)</span>

<span class="nc" id="L33">    private val logger = logger {}</span>

<span class="nc" id="L35">    private val result = CompletableDeferred&lt;Result&gt;()</span>
    private var server: EmbeddedServer&lt;*, *&gt;? = null

    fun awaitReponse(): CompletableDeferred&lt;Result&gt; {
<span class="nc" id="L39">        logger.trace { &quot;awaitReponse&quot; }</span>
<span class="nc bnc" id="L40" title="All 2 branches missed.">        if (server != null) {</span>
<span class="nc" id="L41">            logger.debug { &quot;Server already running&quot; }</span>
<span class="nc" id="L42">            return result</span>
        }

<span class="nc" id="L45">        logger.debug { &quot;Starting local server on port ${callbackServerConfig.port}&quot; }</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">        server = embeddedServer(Netty, configure = { envConfig() }) {</span>
<span class="nc" id="L47">            routing {</span>
<span class="nc bnc" id="L48"
      title="All 3 branches missed.">                get(callbackServerConfig.callbackPath) {</span>
<span class="nc" id="L49">                    logger.debug { &quot;Received callback&quot; }</span>
<span class="nc" id="L50">                    val code = URLDecoder.decode(call.request.queryParameters[&quot;code&quot;], &quot;UTF-8&quot;)</span>
<span class="nc" id="L51">                    val session = call.request.queryParameters[&quot;session&quot;]</span>
<span class="nc" id="L52">                    val error = call.request.queryParameters[&quot;error&quot;]</span>
<span class="nc" id="L53">                    val state = call.request.queryParameters[&quot;state&quot;]</span>

                    // Show a simple page to the user
<span class="nc bnc" id="L56"
      title="All 2 branches missed.">                    call.respondHtml(HttpStatusCode.OK) {</span>
<span class="nc" id="L57">                        head {</span>
<span class="nc" id="L58">                            title {</span>
<span class="nc" id="L59">                                +&quot;DroidTrader - Oauth Page&quot;</span>
<span class="nc" id="L60">                            }</span>
<span class="nc" id="L61">                        }</span>
<span class="nc" id="L62">                        body {</span>
<span class="nc" id="L63">                            h3 {</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">                                if (error == null) {</span>
<span class="nc" id="L65">                                    +&quot;Authorization complete&quot;</span>
                                } else {
<span class="nc" id="L67">                                    +&quot;Authorization failed&quot;</span>
<span class="nc" id="L68">                                    span {</span>
<span class="nc" id="L69">                                        +&quot;Error: $error&quot;</span>
<span class="nc" id="L70">                                    }</span>
                                }
<span class="nc" id="L72">                            }</span>
<span class="nc" id="L73">                            p {</span>
<span class="nc" id="L74">                                +&quot;You can close this page at any time.&quot;</span>
<span class="nc" id="L75">                            }</span>
<span class="nc" id="L76">                        }</span>
<span class="nc" id="L77">                    }</span>

                    // Complete the result and stop the server shortly after
<span class="nc bnc" id="L80" title="All 2 branches missed.">                    if (!result.isCompleted) {</span>
<span class="nc" id="L81">                        val value = Result(code, session, state, error)</span>
<span class="nc" id="L82">                        logger.debug { &quot;oauth callback result: $value&quot; }</span>
<span class="nc" id="L83">                        result.complete(value)</span>
                    }
                    // stop asynchronously to let response flush
                    // small delay avoids abrupt connection close
<span class="nc" id="L87">                    call.application.monitor.subscribe(ApplicationStopped) {</span>
                        // no-op
<span class="nc" id="L89">                    }</span>
                    // Stop the server on a separate thread
<span class="nc" id="L91">                    Thread {</span>
<span class="nc" id="L92">                        Thread.sleep(200)</span>
<span class="nc" id="L93">                        stop()</span>
<span class="nc" id="L94">                    }.start()</span>
<span class="nc" id="L95">                }</span>
<span class="nc" id="L96">            }</span>
<span class="nc" id="L97">        }.start(false)</span>
<span class="nc" id="L98">        logger.debug { &quot;Local server started&quot; }</span>

<span class="nc" id="L100">        return result</span>
    }

    fun stop() {
<span class="nc" id="L104">        logger.debug { &quot;Stopping local server&quot; }</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">        server?.stop(gracePeriodMillis = 200, timeoutMillis = 1000)</span>
<span class="nc" id="L106">        server = null</span>
<span class="nc" id="L107">    }</span>

    private fun ApplicationEngine.Configuration.envConfig() {
<span class="nc" id="L110">        val keyStore = KeyStore.getInstance(callbackServerConfig.sslCertType).apply {</span>
<span class="nc" id="L111">            FileInputStream(File(callbackServerConfig.sslCertLocation)).use {</span>
<span class="nc" id="L112">                load(it, callbackServerConfig.sslCertPassword.toCharArray())</span>
<span class="nc" id="L113">            }</span>
<span class="nc" id="L114">        }</span>
<span class="nc" id="L115">        sslConnector(</span>
<span class="nc" id="L116">            keyStore = keyStore,</span>
<span class="nc" id="L117">            keyAlias = callbackServerConfig.sslCertAlias,</span>
<span class="nc" id="L118">            keyStorePassword = { callbackServerConfig.sslCertPassword.toCharArray() },</span>
<span class="nc"
      id="L119">            privateKeyPassword = { callbackServerConfig.sslCertPassword.toCharArray() }) {</span>
<span class="nc" id="L120">            port = callbackServerConfig.port</span>
<span class="nc" id="L121">            keyStorePath = File(callbackServerConfig.sslCertLocation)</span>
<span class="nc" id="L122">        }</span>
<span class="nc" id="L123">    }</span>
}
</pre>
<div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span>
</div>
</body>
</html>