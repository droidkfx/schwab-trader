<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
    <link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/>
    <link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/>
    <title>ValueDataBinding.kt</title>
    <link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/>
    <script type="text/javascript" src="../jacoco-resources/prettify.js"></script>
</head>
<body onload="window['PR_TAB_WIDTH']=4;prettyPrint()">
<div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html"
                                                              class="el_session">Sessions</a></span><a
        href="../index.html" class="el_report">schwab-trader</a> &gt; <a href="index.source.html" class="el_package">com.droidkfx.st.util.databind</a>
    &gt; <span class="el_source">ValueDataBinding.kt</span></div>
<h1>ValueDataBinding.kt</h1>
<pre class="source lang-java linenums">package com.droidkfx.st.util.databind

import io.github.oshai.kotlinlogging.KotlinLogging.logger

typealias DataBindChangeListener&lt;T&gt; = (oldValue: T, newValue: T) -&gt; Unit

typealias DataBindValueListener&lt;T&gt; = (newValue: T) -&gt; Unit

fun &lt;T&gt; DataBindValueListener&lt;T&gt;.asChangeListener(): DataBindChangeListener&lt;T&gt; {
<span class="fc" id="L10">    return { _, newValue -&gt; this(newValue) }</span>
}

<span class="fc" id="L13">class ValueDataBinding&lt;T&gt;(initialValue: T) : ReadOnlyValueDataBinding&lt;T&gt;, ReadWriteValueDataBinding&lt;T&gt; {</span>
<span class="pc" id="L14">    private val logger = logger {}</span>
<span class="fc" id="L15">    private val listeners = mutableListOf&lt;DataBindChangeListener&lt;T&gt;&gt;()</span>

    override fun addListener(listener: DataBindChangeListener&lt;T&gt;) {
<span class="fc" id="L18">        logger.trace { &quot;addListener $listener&quot; }</span>
<span class="fc" id="L19">        listeners.add(listener)</span>
<span class="fc" id="L20">    }</span>

    override fun addListener(listener: DataBindValueListener&lt;T&gt;) {
<span class="fc" id="L23">        addListener(listener.asChangeListener())</span>
<span class="fc" id="L24">    }</span>

<span class="fc" id="L26">    override var value: T = initialValue</span>
        set(newValue) {
<span class="fc" id="L28">            val oldValue = field</span>
<span class="fc bfc" id="L29" title="All 2 branches covered.">            if (oldValue == newValue) {</span>
<span class="fc" id="L30">                logger.trace { &quot;Value not changed, ignoring&quot; }</span>
<span class="fc" id="L31">                return</span>
            }
<span class="fc" id="L33">            logger.trace { &quot;value changed from $oldValue to $newValue&quot; }</span>
<span class="fc" id="L34">            field = newValue</span>
<span class="fc" id="L35">            listeners.forEach {</span>
<span class="fc" id="L36">                logger.trace { &quot;Invoking listener $it&quot; }</span>
<span class="fc" id="L37">                it(oldValue, newValue)</span>
<span class="fc" id="L38">            }</span>
<span class="fc" id="L39">        }</span>
}

interface SubscribeDataBinding&lt;T&gt; {
    fun addListener(listener: DataBindChangeListener&lt;T&gt;)
    fun addListener(listener: DataBindValueListener&lt;T&gt;)
}

interface ReadOnlyValueDataBinding&lt;T&gt; : SubscribeDataBinding&lt;T&gt; {
    val value: T
}

interface ReadWriteValueDataBinding&lt;T&gt; : SubscribeDataBinding&lt;T&gt; {
    var value: T
}

fun &lt;T&gt; ValueDataBinding&lt;T&gt;.readOnly(): ReadOnlyValueDataBinding&lt;T&gt; {
<span class="fc" id="L56">    return this.readOnlyMapped { it }</span>
}

<span class="fc" id="L59">fun &lt;T&gt; T.toDataBinding(): ValueDataBinding&lt;T&gt; = ValueDataBinding(this)</span>

<span class="fc" id="L61">private abstract class MappedDataBinding&lt;T, U&gt;(</span>
<span class="fc" id="L62">    private val delegate: SubscribeDataBinding&lt;T&gt;,</span>
<span class="fc" id="L63">    protected val mapperFrom: (T) -&gt; U</span>
) : SubscribeDataBinding&lt;U&gt; {
<span class="pc" id="L65">    private val logger = logger {}</span>

    override fun addListener(listener: DataBindChangeListener&lt;U&gt;) {
<span class="fc" id="L68">        delegate.addListener { oldValue, newValue -&gt;</span>
<span class="fc" id="L69">            val mappedOldValue = mapperFrom(oldValue)</span>
<span class="fc" id="L70">            val mappedNewValue = mapperFrom(newValue)</span>
<span class="fc bfc" id="L71" title="All 2 branches covered.">            if (mappedOldValue == mappedNewValue) {</span>
<span class="fc" id="L72">                logger.trace { &quot;Value not changed, ignoring&quot; }</span>
<span class="fc" id="L73">                return@addListener</span>
            }
<span class="fc" id="L75">            listener(mapperFrom(oldValue), mapperFrom(newValue))</span>
<span class="fc" id="L76">        }</span>
<span class="fc" id="L77">    }</span>

    override fun addListener(listener: DataBindValueListener&lt;U&gt;) {
<span class="fc" id="L80">        addListener(listener.asChangeListener())</span>
<span class="fc" id="L81">    }</span>
}

<span class="fc" id="L84">private class ReadOnlyMappedDataBinding&lt;T, U&gt;(</span>
<span class="fc" id="L85">    private val delegate: ReadOnlyValueDataBinding&lt;T&gt;,</span>
    mapperFrom: (T) -&gt; U
<span class="fc"
      id="L87">) : MappedDataBinding&lt;T, U&gt;(delegate, mapperFrom), ReadOnlyValueDataBinding&lt;U&gt; {</span>
    override val value: U
<span class="fc" id="L89">        get() = mapperFrom(delegate.value)</span>
}

<span class="fc" id="L92">private class ReadWriteMappedDataBinding&lt;T, U&gt;(</span>
<span class="fc" id="L93">    private val delegate: ReadWriteValueDataBinding&lt;T&gt;,</span>
    mapperFrom: (T) -&gt; U,
<span class="fc" id="L95">    private val mapperTo: (T, U) -&gt; T</span>
<span class="fc"
      id="L96">) : MappedDataBinding&lt;T, U&gt;(delegate, mapperFrom), ReadWriteValueDataBinding&lt;U&gt; {</span>
    override var value: U
<span class="fc" id="L98">        get() = mapperFrom(delegate.value)</span>
        set(value) {
<span class="fc" id="L100">            delegate.value = mapperTo(delegate.value, value)</span>
<span class="fc" id="L101">        }</span>
}

fun &lt;T, U&gt; ReadOnlyValueDataBinding&lt;T&gt;.readOnlyMapped(mapper: (T) -&gt; U): ReadOnlyValueDataBinding&lt;U&gt; {
<span class="fc" id="L105">    return ReadOnlyMappedDataBinding(this, mapper)</span>
}

fun &lt;T, U&gt; ReadWriteValueDataBinding&lt;T&gt;.mapped(
    mapperFrom: (T) -&gt; U,
    mapperUp: (T, U) -&gt; T
): ReadWriteValueDataBinding&lt;U&gt; {
<span class="fc" id="L112">    return ReadWriteMappedDataBinding(this, mapperFrom, mapperUp)</span>
}
</pre>
<div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span>
</div>
</body>
</html>