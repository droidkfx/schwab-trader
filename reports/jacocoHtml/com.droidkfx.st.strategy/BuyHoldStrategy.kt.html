<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
    <link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/>
    <link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/>
    <title>BuyHoldStrategy.kt</title>
    <link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/>
    <script type="text/javascript" src="../jacoco-resources/prettify.js"></script>
</head>
<body onload="window['PR_TAB_WIDTH']=4;prettyPrint()">
<div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html"
                                                              class="el_session">Sessions</a></span><a
        href="../index.html" class="el_report">schwab-trader</a> &gt; <a href="index.source.html" class="el_package">com.droidkfx.st.strategy</a>
    &gt; <span class="el_source">BuyHoldStrategy.kt</span></div>
<h1>BuyHoldStrategy.kt</h1>
<pre class="source lang-java linenums">package com.droidkfx.st.strategy

import com.droidkfx.st.position.Position
import com.droidkfx.st.position.PositionTarget
import com.droidkfx.st.schwab.client.QuotesClient
import java.math.BigDecimal
import java.math.RoundingMode

<span class="nc" id="L9">internal class BuyHoldStrategy(</span>
<span class="nc" id="L10">    private val quotesClient: QuotesClient</span>
) : StrategyEngine {

<span class="nc" id="L13">    data class PositionProperties(</span>
<span class="nc" id="L14">        val position: Position,</span>
<span class="nc" id="L15">        val target: PositionTarget,</span>
<span class="nc" id="L16">        var delta: BigDecimal = BigDecimal.ZERO</span>
<span class="nc" id="L17">    )</span>

    override fun buildRecommendations(
        positions: List&lt;Position&gt;,
        allocationTargets: List&lt;PositionTarget&gt;,
        accountCash: BigDecimal
    ): List&lt;PositionRecommendation&gt; {
<span class="nc" id="L24">        val knownPositions = allocationTargets.map { target -&gt;</span>
<span class="nc" id="L25">            positions.firstOrNull { it.symbol == target.symbol }</span>
<span class="nc bnc" id="L26"
      title="All 2 branches missed.">                ?.let { PositionProperties(it, target) }</span>
<span class="nc" id="L27">                ?: PositionProperties(Position(target.symbol, BigDecimal.ZERO), target)</span>
        }

<span class="nc" id="L30">        val (unmappedPositions, mappedPositions) = knownPositions.partition { it.position.lastKnownPrice == BigDecimal.ZERO }</span>
<span class="nc" id="L31">        val fetchedQuotes = unmappedPositions.map { it.position.symbol }.let {</span>
<span class="nc bnc" id="L32" title="All 2 branches missed.">            if (it.isEmpty()) emptyMap()</span>
<span class="nc bnc" id="L33" title="All 2 branches missed.">            else quotesClient.getQuotesForSymbols(it).data ?: emptyMap()</span>
        }

<span class="nc" id="L36">        val positionAllocations = mappedPositions + unmappedPositions.mapNotNull {</span>
<span class="nc" id="L37">            it.copy(</span>
<span class="nc" id="L38">                position = it.position.copy(</span>
<span class="nc bnc" id="L39" title="All 6 branches missed.">                    lastKnownPrice = fetchedQuotes[it.position.symbol]?.quote?.lastPrice ?: BigDecimal.ZERO</span>
                )
<span class="nc bnc" id="L41" title="All 2 branches missed.">            ).let { if (it.position.lastKnownPrice == BigDecimal.ZERO) null else it }</span>
        }

<span class="nc bnc" id="L44" title="All 2 branches missed.">        val totalManagedValue = positionAllocations.sumOf { it.position.lastKnownValue } + accountCash</span>
<span class="nc" id="L45">        positionAllocations.forEach {</span>
            // can't use `==` because that requires scale to be equal
<span class="nc bnc" id="L47" title="All 2 branches missed.">            val actualAllocation = if (totalManagedValue.compareTo(BigDecimal.ZERO) == 0) {</span>
<span class="nc" id="L48">                BigDecimal.ZERO</span>
            } else {
<span class="nc" id="L50">                (it.position.lastKnownValue / totalManagedValue) * BigDecimal(100)</span>
            }
<span class="nc" id="L52">            it.delta = (actualAllocation - it.target.allocationTarget).setScale(4)</span>
<span class="nc" id="L53">        }</span>

<span class="nc bnc" id="L55" title="All 2 branches missed.">        val (onlyBuyAllocations, holdAllocations) = positionAllocations.partition { it.delta &lt; BigDecimal.ZERO }</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">        val totalDelta = onlyBuyAllocations.sumOf { it.delta }.abs()</span>
<span class="nc" id="L57">        var cashToAllocate = BigDecimal.ZERO</span>

<span class="nc" id="L59">        data class AllocationIntermediary(</span>
<span class="nc" id="L60">            val positionProperties: PositionProperties,</span>
<span class="nc" id="L61">            val deltaToNextShare: BigDecimal,</span>
<span class="nc" id="L62">            val recommendation: PositionRecommendation</span>
        )

<span class="nc" id="L65">        val easyBuyAllocations = onlyBuyAllocations.map {</span>
<span class="nc" id="L66">            val weigthedDelta = it.delta.abs() / totalDelta</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">            val valueToAllocate = if (accountCash &lt; BigDecimal.ZERO) BigDecimal.ZERO else weigthedDelta * accountCash</span>
<span class="nc" id="L68">            val sharesToAllocate = (valueToAllocate / it.position.lastKnownPrice).setScale(0, RoundingMode.FLOOR)</span>
<span class="nc" id="L69">            val unallocatedValue = valueToAllocate - (sharesToAllocate * it.position.lastKnownPrice)</span>
<span class="nc" id="L70">            cashToAllocate += unallocatedValue</span>

<span class="nc" id="L72">            AllocationIntermediary(</span>
<span class="nc" id="L73">                it,</span>
<span class="nc" id="L74">                it.position.lastKnownPrice - unallocatedValue,</span>
<span class="nc" id="L75">                PositionRecommendation(</span>
<span class="nc" id="L76">                    it.position.symbol,</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">                    if (sharesToAllocate == BigDecimal.ZERO) StrategyAction.HOLD else StrategyAction.BUY,</span>
<span class="nc" id="L78">                    sharesToAllocate,</span>
<span class="nc" id="L79">                    it.position.lastKnownPrice</span>
                )
<span class="nc" id="L81">            )</span>
        }

<span class="nc" id="L84">        var finalBuyAllocations = easyBuyAllocations</span>
<span class="nc" id="L85">        var changeMade = true</span>
<span class="nc bnc" id="L86" title="All 4 branches missed.">        while (changeMade &amp;&amp; cashToAllocate &gt; BigDecimal.ZERO) {</span>
<span class="nc" id="L87">            changeMade = false</span>
<span class="nc" id="L88">            finalBuyAllocations = finalBuyAllocations.sortedBy { it.deltaToNextShare }</span>
<span class="nc" id="L89">                .map {</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">                    if (it.positionProperties.position.lastKnownPrice &lt; cashToAllocate) {</span>
<span class="nc" id="L91">                        cashToAllocate -= it.positionProperties.position.lastKnownPrice</span>
<span class="nc" id="L92">                        changeMade = true</span>
<span class="nc" id="L93">                        it.copy(</span>
<span class="nc"
      id="L94">                            deltaToNextShare = it.positionProperties.position.lastKnownPrice,</span>
<span class="nc" id="L95">                            recommendation = it.recommendation.copy(</span>
<span class="nc" id="L96">                                quantity = it.recommendation.quantity + BigDecimal.ONE,</span>
<span class="nc" id="L97">                                recommendation = StrategyAction.BUY</span>
                            )
                        )
                    } else {
<span class="nc" id="L101">                        it</span>
<span class="nc" id="L102">                    }</span>
                }
        }

<span class="nc" id="L106">        return finalBuyAllocations.map { it.recommendation } + holdAllocations.map {</span>
<span class="nc" id="L107">            PositionRecommendation(</span>
<span class="nc" id="L108">                it.position.symbol,</span>
<span class="nc" id="L109">                StrategyAction.HOLD,</span>
<span class="nc" id="L110">                BigDecimal.ZERO,</span>
<span class="nc" id="L111">                it.position.lastKnownPrice</span>
<span class="nc" id="L112">            )</span>
        }
    }
}
</pre>
<div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span>
</div>
</body>
</html>