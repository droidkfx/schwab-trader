<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
    <link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/>
    <link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/>
    <title>AccountPositionDetail.kt</title>
    <link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/>
    <script type="text/javascript" src="../jacoco-resources/prettify.js"></script>
</head>
<body onload="window['PR_TAB_WIDTH']=4;prettyPrint()">
<div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html"
                                                              class="el_session">Sessions</a></span><a
        href="../index.html" class="el_report">schwab-trader</a> &gt; <a href="index.source.html" class="el_package">com.droidkfx.st.view.account</a>
    &gt; <span class="el_source">AccountPositionDetail.kt</span></div>
<h1>AccountPositionDetail.kt</h1>
<pre class="source lang-java linenums">package com.droidkfx.st.view.account

import com.droidkfx.st.position.AccountPosition
import com.droidkfx.st.position.PositionTarget
import com.droidkfx.st.view.addCoActionListener
import io.github.oshai.kotlinlogging.KotlinLogging
import java.awt.GridBagConstraints
import java.awt.GridBagLayout
import java.awt.Insets
import java.math.BigDecimal
import javax.swing.JButton
import javax.swing.JLabel
import javax.swing.JPanel
import javax.swing.JScrollPane
import javax.swing.JTable
import javax.swing.border.EmptyBorder
import javax.swing.table.AbstractTableModel

<span class="nc" id="L19">private class AccountPositionTableModelRow(</span>
<span class="nc" id="L20">    var symbol: String? = null,</span>
<span class="nc" id="L21">    var allocationTarget: BigDecimal? = null</span>
<span class="nc" id="L22">) {</span>
<span class="nc bnc" id="L23"
      title="All 2 branches missed.">    fun toPositionTarget() = symbol?.let { symbol -&gt;</span>
<span class="nc bnc" id="L24"
      title="All 2 branches missed.">        allocationTarget?.let { allocationTarget -&gt;</span>
<span class="nc" id="L25">            PositionTarget(symbol, allocationTarget)</span>
<span class="nc" id="L26">        }</span>
<span class="nc" id="L27">    }</span>
}

<span class="nc" id="L30">private class AccountPositionRowModel(val data: MutableList&lt;AccountPositionTableModelRow&gt;) : AbstractTableModel() {</span>
<span class="nc" id="L31">    init {</span>
<span class="nc bnc" id="L32" title="All 2 branches missed.">        if (data.isEmpty()) {</span>
<span class="nc" id="L33">            data.add(AccountPositionTableModelRow())</span>
        }
<span class="nc" id="L35">    }</span>

    override fun getColumnName(columnIndex: Int): String {
<span class="nc bnc" id="L38" title="All 3 branches missed.">        return when (columnIndex) {</span>
<span class="nc" id="L39">            0 -&gt; &quot;Position&quot;</span>
<span class="nc" id="L40">            1 -&gt; &quot;Allocation&quot;</span>
<span class="nc" id="L41">            else -&gt; &quot;&quot;</span>
        }
    }

    override fun getRowCount(): Int {
<span class="nc" id="L46">        return data.size</span>
    }

    override fun getColumnCount(): Int {
<span class="nc" id="L50">        return 2</span>
    }

    override fun setValueAt(value: Any?, rowIndex: Int, columnIndex: Int) {
<span class="nc bnc" id="L54" title="All 2 branches missed.">        if (value == null) {</span>
<span class="nc" id="L55">            return</span>
        }
<span class="nc bnc" id="L57" title="All 3 branches missed.">        when (columnIndex) {</span>
<span class="nc" id="L58">            0 -&gt; data[rowIndex].symbol = value.toString()</span>
<span class="nc" id="L59">            1 -&gt; data[rowIndex].allocationTarget = BigDecimal(value.toString())</span>
        }
<span class="nc bnc" id="L61" title="All 2 branches missed.">        if (rowIndex == data.size - 1) {</span>
<span class="nc" id="L62">            data.add(AccountPositionTableModelRow())</span>
        }
<span class="nc" id="L64">        fireTableDataChanged()</span>
<span class="nc" id="L65">    }</span>

    override fun getValueAt(rowIndex: Int, columnIndex: Int): String? {
<span class="nc bnc" id="L68" title="All 3 branches missed.">        return when (columnIndex) {</span>
<span class="nc" id="L69">            0 -&gt; data[rowIndex].symbol</span>
<span class="nc bnc" id="L70"
      title="All 4 branches missed.">            1 -&gt; data[rowIndex].allocationTarget?.let {</span>
<span class="nc" id="L71">                &quot;%.2f %%&quot;.format(it)</span>
<span class="nc" id="L72">            } ?: &quot;&quot;</span>

<span class="nc" id="L74">            else -&gt; null</span>
        }
    }

<span class="nc" id="L78">    override fun isCellEditable(rowIndex: Int, columnIndex: Int): Boolean = true</span>
}

<span class="nc"
      id="L81">abstract class AccountPositionDetail(acctData: AccountPosition) : JPanel(GridBagLayout()) {</span>
<span class="nc" id="L82">    private val logger = KotlinLogging.logger {}</span>

<span class="nc" id="L84">    init {</span>
<span class="nc" id="L85">        logger.trace { &quot;Initializing&quot; }</span>

<span class="nc" id="L87">        addRow(&quot;Account Name:&quot;, acctData.account.name, 0)</span>
<span class="nc" id="L88">        addRow(&quot;Account ID:&quot;, acctData.account.id.truncateMiddle(), 1)</span>
<span class="nc" id="L89">        addRow(&quot;Account Number:&quot;, acctData.account.accountNumber, 2)</span>
<span class="nc" id="L90">        addRow(&quot;Account Hash:&quot;, acctData.account.accountNumberHash.truncateMiddle(), 3)</span>

<span class="nc" id="L92">        val tableModel = AccountPositionRowModel(acctData.positionTargets.map {</span>
<span class="nc" id="L93">            AccountPositionTableModelRow(</span>
<span class="nc" id="L94">                it.symbol,</span>
<span class="nc" id="L95">                it.allocationTarget</span>
<span class="nc" id="L96">            )</span>
<span class="nc" id="L97">        }.toMutableList())</span>
<span class="nc" id="L98">        val saveButton = JButton(&quot;Save&quot;).apply {</span>
<span class="nc" id="L99">            isEnabled = false</span>
<span class="nc" id="L100">            addActionListener {</span>
<span class="nc" id="L101">                logger.trace { &quot;Save button clicked&quot; }</span>
<span class="nc" id="L102">                isEnabled = false</span>
<span class="nc" id="L103">            }</span>
<span class="nc" id="L104">            addCoActionListener {</span>
<span class="nc" id="L105">                save(acctData.account.id, tableModel.data.mapNotNull { it.toPositionTarget() })</span>
<span class="nc" id="L106">            }</span>
<span class="nc" id="L107">        }</span>
<span class="nc" id="L108">        tableModel.apply {</span>
<span class="nc" id="L109">            addTableModelListener {</span>
<span class="nc" id="L110">                saveButton.isEnabled = true</span>
<span class="nc" id="L111">            }</span>
<span class="nc" id="L112">        }</span>

<span class="nc" id="L114">        add(</span>
<span class="nc" id="L115">            JScrollPane(JTable(tableModel)),</span>
<span class="nc" id="L116">            GridBagConstraints().apply {</span>
<span class="nc" id="L117">                gridy = 5</span>
<span class="nc" id="L118">                gridwidth = 2</span>
<span class="nc" id="L119">                weighty = 1.0</span>
<span class="nc" id="L120">                weightx = 1.0</span>
<span class="nc" id="L121">                fill = GridBagConstraints.BOTH</span>
<span class="nc" id="L122">            })</span>

<span class="nc" id="L124">        add(JPanel().apply {</span>
<span class="nc" id="L125">            border = EmptyBorder(5, 0, 5, 0)</span>
<span class="nc" id="L126">            add(saveButton)</span>
<span class="nc" id="L127">        }, GridBagConstraints().apply {</span>
<span class="nc" id="L128">            gridx = 0</span>
<span class="nc" id="L129">            gridy = 6</span>
<span class="nc" id="L130">            gridwidth = 2</span>
<span class="nc" id="L131">            anchor = GridBagConstraints.CENTER</span>
<span class="nc" id="L132">        })</span>
<span class="nc" id="L133">    }</span>

    abstract suspend fun save(accountId: String, newPositionTargets: List&lt;PositionTarget&gt;)

    private fun addRow(title: String, value: String, row: Int) {
<span class="nc" id="L138">        add(JLabel(title), GridBagConstraints().apply {</span>
<span class="nc" id="L139">            gridx = 0</span>
<span class="nc" id="L140">            gridy = row</span>
<span class="nc" id="L141">            anchor = GridBagConstraints.EAST</span>
<span class="nc" id="L142">            insets = Insets(1, 5, 1, 10)</span>
<span class="nc" id="L143">        })</span>
<span class="nc" id="L144">        add(JLabel(value), GridBagConstraints().apply {</span>
<span class="nc" id="L145">            gridx = 1</span>
<span class="nc" id="L146">            gridy = row</span>
<span class="nc" id="L147">            anchor = GridBagConstraints.WEST</span>
<span class="nc" id="L148">            fill = GridBagConstraints.HORIZONTAL</span>
<span class="nc" id="L149">            weightx = 1.0</span>
<span class="nc" id="L150">            insets = Insets(1, 0, 1, 5)</span>
<span class="nc" id="L151">        })</span>
<span class="nc" id="L152">    }</span>

<span class="nc" id="L154">    private fun String.truncateMiddle(maxLength: Int = 20): String {</span>
<span class="nc" id="L155">        return when {</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">            length &lt;= maxLength -&gt; this</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">            maxLength &lt;= 3 -&gt; &quot;...&quot;</span>
            else -&gt; {
<span class="nc" id="L159">                val sideLength = (maxLength - 3) / 2</span>
<span class="nc" id="L160">                take(sideLength) + &quot;...&quot; + takeLast(sideLength)</span>
            }
        }
    }
}
</pre>
<div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span>
</div>
</body>
</html>