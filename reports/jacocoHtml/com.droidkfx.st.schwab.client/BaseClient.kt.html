<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
    <link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/>
    <link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/>
    <title>BaseClient.kt</title>
    <link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/>
    <script type="text/javascript" src="../jacoco-resources/prettify.js"></script>
</head>
<body onload="window['PR_TAB_WIDTH']=4;prettyPrint()">
<div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html"
                                                              class="el_session">Sessions</a></span><a
        href="../index.html" class="el_report">schwab-trader</a> &gt; <a href="index.source.html" class="el_package">com.droidkfx.st.schwab.client</a>
    &gt; <span class="el_source">BaseClient.kt</span></div>
<h1>BaseClient.kt</h1>
<pre class="source lang-java linenums">package com.droidkfx.st.schwab.client

import com.droidkfx.st.config.SchwabClientConfig
import com.droidkfx.st.schwab.oauth.OauthStatus
import com.droidkfx.st.util.databind.ReadOnlyValueDataBinding
import com.droidkfx.st.util.databind.ValueDataBinding
import io.github.oshai.kotlinlogging.KLogger
import io.ktor.client.HttpClient
import io.ktor.client.call.body
import io.ktor.client.request.HttpRequestBuilder
import io.ktor.client.request.request
import io.ktor.client.statement.HttpResponse
import io.ktor.http.ContentType
import io.ktor.http.HttpMethod
import io.ktor.http.URLProtocol
import io.ktor.http.contentType
import io.ktor.http.path
import kotlinx.coroutines.runBlocking
import kotlinx.serialization.Serializable
import kotlinx.serialization.json.Json
import kotlinx.serialization.json.JsonObject

<span class="nc" id="L23">abstract class BaseClient(</span>
<span class="nc" id="L24">    protected val config: ReadOnlyValueDataBinding&lt;SchwabClientConfig&gt;,</span>
<span class="nc" id="L25">    protected val client: HttpClient,</span>
<span class="nc" id="L26">    protected val requestTokenRefresh: ValueDataBinding&lt;Boolean&gt;,</span>
<span class="nc" id="L27">    protected val oathToken: ValueDataBinding&lt;String?&gt; = ValueDataBinding(null),</span>
<span class="nc" id="L28">    protected val oauthTokenStatus: ReadOnlyValueDataBinding&lt;OauthStatus&gt;,</span>
<span class="nc" id="L29">    protected val defaultPathSegments: List&lt;String&gt; = emptyList()</span>
<span class="nc" id="L30">) {</span>
    protected abstract val logger: KLogger
    protected val authorization: String
<span class="nc" id="L33">        get() = &quot;Bearer ${oathToken.value}&quot;</span>

<span class="nc" id="L35">    protected val json = Json {</span>
<span class="nc" id="L36">        ignoreUnknownKeys = true</span>
<span class="nc" id="L37">        isLenient = true</span>
<span class="nc" id="L38">        coerceInputValues = true</span>
<span class="nc" id="L39">    }</span>

<span class="nc" id="L41">    protected inline fun &lt;reified T&gt; request(</span>
        method: HttpMethod,
<span class="nc" id="L43">        crossinline block: HttpRequestBuilder.() -&gt; Unit = {},</span>
<span class="nc" id="L44">    ) = runBlocking {</span>
<span class="nc" id="L45">        if (oauthTokenStatus.value == OauthStatus.EXPIRED) {</span>
<span class="nc" id="L46">            logger.info { &quot;Oauth token expired, attempting token refresh&quot; }</span>
<span class="nc" id="L47">            requestTokenRefresh.value = !requestTokenRefresh.value</span>
<span class="nc" id="L48">        } else if (oauthTokenStatus.value != OauthStatus.READY) {</span>
<span class="nc" id="L49">            return@runBlocking ApiResponse(error = ErrorResponse(emptyList(), &quot;Oauth token not ready&quot;))</span>
        }

<span class="nc" id="L52">        var respBody: String? = null</span>
<span class="nc" id="L53">        try {</span>
<span class="nc" id="L54">            var resp = doRequestInternal(method, block)</span>

<span class="nc" id="L56">            if (resp.status.value == 401) {</span>
<span class="nc" id="L57">                logger.info { &quot;Unauthorized, attempting token refresh&quot; }</span>
<span class="nc" id="L58">                requestTokenRefresh.value = !requestTokenRefresh.value</span>
<span class="nc" id="L59">                resp = doRequestInternal(method, block)</span>
            }

<span class="nc" id="L62">            respBody = resp.body&lt;String&gt;()</span>
<span class="nc" id="L63">            if (resp.status.value in 200..299) {</span>
<span class="nc" id="L64">                if (T::class == Unit::class) ApiResponse()</span>
<span class="nc" id="L65">                else ApiResponse(json.decodeFromString&lt;T&gt;(respBody))</span>
<span class="nc" id="L66">            } else if (respBody == &quot;&quot;) {</span>
<span class="nc" id="L67">                ApiResponse(error = ErrorResponse(emptyList(), &quot;${resp.status.value} ${resp.status.description}&quot;))</span>
            } else {
<span class="nc" id="L69">                ApiResponse(error = json.decodeFromString(respBody))</span>
            }
<span class="nc" id="L71">        } catch (e: Exception) {</span>
<span class="nc" id="L72">            logger.error(e) { &quot;Error making request&quot; }</span>
<span class="nc" id="L73">            logger.error { &quot;Response body: $respBody&quot; }</span>
<span class="nc" id="L74">            ApiResponse(error = ErrorResponse(emptyList(), e.message ?: &quot;Unknown error&quot;))</span>
<span class="nc" id="L75">        }.also {</span>
<span class="nc" id="L76">            logger.trace { &quot;Response: $it&quot; }</span>
<span class="nc" id="L77">        }</span>
<span class="nc" id="L78">    }</span>

    protected suspend inline fun doRequestInternal(
        method: HttpMethod,
        block: HttpRequestBuilder.() -&gt; Unit
<span class="nc" id="L83">    ): HttpResponse = client.request {</span>
<span class="nc" id="L84">        this.method = method</span>
<span class="nc" id="L85">        url {</span>
<span class="nc" id="L86">            protocol = URLProtocol.HTTPS</span>
<span class="nc" id="L87">            host = config.value.baseApiUrl</span>
<span class="nc" id="L88">            path(*defaultPathSegments.toTypedArray())</span>
<span class="nc" id="L89">        }</span>

<span class="nc" id="L91">        headers.append(&quot;Authorization&quot;, authorization)</span>
<span class="nc" id="L92">        headers.append(&quot;Accept&quot;, &quot;application/json&quot;)</span>

<span class="nc" id="L94">        block()</span>
<span class="nc" id="L95">        logger.trace { &quot;Request: \n${this.method} ${url.buildString()}\n ${this.headers.entries()}\n ${this.body}&quot; }</span>
<span class="nc" id="L96">    }</span>

<span class="nc" id="L98">    protected inline fun &lt;reified T&gt; get(crossinline block: HttpRequestBuilder.() -&gt; Unit = {}): ApiResponse&lt;T&gt; =</span>
<span class="nc" id="L99">        request(HttpMethod.Get, block)</span>

<span class="nc" id="L101">    protected inline fun &lt;reified T&gt; post(crossinline block: HttpRequestBuilder.() -&gt; Unit = {}): ApiResponse&lt;T&gt; =</span>
<span class="nc" id="L102">        request(HttpMethod.Post) {</span>
<span class="nc" id="L103">            contentType(ContentType.Application.Json)</span>
<span class="nc" id="L104">            block()</span>
<span class="nc" id="L105">        }</span>

<span class="nc" id="L107">    protected inline fun &lt;reified T&gt; getAt(</span>
<span class="nc" id="L108">        vararg segments: String = emptyArray(),</span>
<span class="nc" id="L109">        crossinline block: HttpRequestBuilder.() -&gt; Unit = {}</span>
    ): ApiResponse&lt;T&gt; =
<span class="nc" id="L111">        get {</span>
<span class="nc" id="L112">            url {</span>
<span class="nc" id="L113">                path(*defaultPathSegments.toTypedArray(), *segments)</span>
<span class="nc" id="L114">            }</span>
<span class="nc" id="L115">            block()</span>
<span class="nc" id="L116">        }</span>

<span class="nc" id="L118">    protected inline fun &lt;reified T&gt; postAt(</span>
<span class="nc" id="L119">        vararg segments: String = emptyArray(),</span>
<span class="nc" id="L120">        crossinline block: HttpRequestBuilder.() -&gt; Unit = {}</span>
    ): ApiResponse&lt;T&gt; =
<span class="nc" id="L122">        post {</span>
<span class="nc" id="L123">            url {</span>
<span class="nc" id="L124">                path(*defaultPathSegments.toTypedArray(), *segments)</span>
<span class="nc" id="L125">            }</span>
<span class="nc" id="L126">            block()</span>
<span class="nc" id="L127">        }</span>
}

<span class="nc" id="L130">data class ApiResponse&lt;T&gt;(val data: T? = null, val error: ErrorResponse? = null)</span>

<span class="nc bnc" id="L132" title="All 18 branches missed.">@Serializable</span>
<span class="nc" id="L133">data class ErrorResponse(val errors: List&lt;JsonObject&gt;? = emptyList(), val message: String? = null)</span>
</pre>
<div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span>
</div>
</body>
</html>