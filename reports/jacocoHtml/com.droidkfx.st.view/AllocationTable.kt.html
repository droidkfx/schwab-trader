<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
    <link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/>
    <link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/>
    <title>AllocationTable.kt</title>
    <link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/>
    <script type="text/javascript" src="../jacoco-resources/prettify.js"></script>
</head>
<body onload="window['PR_TAB_WIDTH']=4;prettyPrint()">
<div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html"
                                                              class="el_session">Sessions</a></span><a
        href="../index.html" class="el_report">schwab-trader</a> &gt; <a href="index.source.html" class="el_package">com.droidkfx.st.view</a>
    &gt; <span class="el_source">AllocationTable.kt</span></div>
<h1>AllocationTable.kt</h1>
<pre class="source lang-java linenums">package com.droidkfx.st.view

import com.droidkfx.st.util.databind.ReadOnlyListDataBinding
import com.droidkfx.st.view.model.AllocationRowViewModel
import com.droidkfx.st.view.model.ObjectTableModel
import io.github.oshai.kotlinlogging.KotlinLogging
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import java.math.BigDecimal
import javax.swing.JScrollPane
import javax.swing.JTable
import javax.swing.SwingUtilities
import javax.swing.event.TableModelListener

<span class="nc" id="L16">abstract class AllocationTable(data: ReadOnlyListDataBinding&lt;AllocationRowViewModel&gt;) : JScrollPane() {</span>
<span class="nc" id="L17">    private val logger = KotlinLogging.logger {}</span>

<span class="nc" id="L19">    private val allocationTableModel: AllocationTableModel = AllocationTableModel(data, ::addNewRow)</span>

<span class="nc" id="L21">    init {</span>
<span class="nc" id="L22">        logger.trace { &quot;Initializing&quot; }</span>
<span class="nc" id="L23">        setViewportView(</span>
<span class="nc" id="L24">            JTable(allocationTableModel).apply {</span>
<span class="nc" id="L25">                autoCreateRowSorter = true</span>
<span class="nc" id="L26">            })</span>
<span class="nc" id="L27">        data.addSwingListener {</span>
<span class="nc" id="L28">            notifyDataChanged()</span>
<span class="nc" id="L29">        }</span>
<span class="nc" id="L30">    }</span>

    fun addTableModelListener(l: TableModelListener) {
<span class="nc" id="L33">        allocationTableModel.addTableModelListener(l)</span>
<span class="nc" id="L34">    }</span>

    abstract suspend fun addNewRow(newRow: AllocationRowViewModel)

    fun notifyDataChanged() {
<span class="nc" id="L39">        allocationTableModel.fireTableDataChanged()</span>
<span class="nc" id="L40">    }</span>
}

<span class="nc" id="L43">private class AllocationTableModel(</span>
    data: List&lt;AllocationRowViewModel&gt;,
<span class="nc" id="L45">    private val addNewRow: suspend (AllocationRowViewModel) -&gt; Unit</span>
) :
<span class="nc"
      id="L47">    ObjectTableModel&lt;AllocationRowViewModel&gt;(data, AllocationRowViewModel::class.java) {</span>
<span class="nc" id="L48">    private var newRow: AllocationRowViewModel = defaultValue()</span>

<span class="nc" id="L50">    fun defaultValue(): AllocationRowViewModel = AllocationRowViewModel(</span>
<span class="nc" id="L51">        &quot;&quot;, BigDecimal.ZERO, BigDecimal.ZERO, BigDecimal.ZERO,</span>
<span class="nc" id="L52">        BigDecimal.ZERO, &quot;&quot;, BigDecimal.ZERO</span>
<span class="nc" id="L53">    )</span>

    fun valueSetup(allocationRowViewModel: AllocationRowViewModel): Boolean {
<span class="nc bnc" id="L56" title="All 6 branches missed.">        return allocationRowViewModel.symbol.isNotEmpty() &amp;&amp; allocationRowViewModel.allocationTarget &gt; BigDecimal.ZERO</span>
    }

    override fun getRowCount(): Int {
<span class="nc" id="L60">        return super.rowCount + 1</span>
    }

    override fun isCellEditable(rowIndex: Int, columnIndex: Int): Boolean {
<span class="nc bnc" id="L64" title="All 2 branches missed.">        return if (rowIndex &gt;= super.rowCount) {</span>
<span class="nc" id="L65">            super.isColumnEditable(columnIndex)</span>
        } else {
<span class="nc" id="L67">            super.isCellEditable(rowIndex, columnIndex)</span>
        }
    }

    override fun setValueAt(value: Any?, rowIndex: Int, columnIndex: Int) {
<span class="nc bnc" id="L72" title="All 2 branches missed.">        if (rowIndex &gt;= super.rowCount) {</span>
<span class="nc" id="L73">            setValueOn(newRow, columnIndex, value)</span>
<span class="nc" id="L74">            super.fireTableCellUpdated(rowIndex, columnIndex)</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">            if (valueSetup(newRow)) {</span>
<span class="nc" id="L76">                CoroutineScope(Dispatchers.Default).launch {</span>
<span class="nc" id="L77">                    addNewRow(newRow)</span>
<span class="nc" id="L78">                    SwingUtilities.invokeLater {</span>
<span class="nc" id="L79">                        super.fireTableRowsInserted(super.rowCount, super.rowCount)</span>
<span class="nc" id="L80">                    }</span>
<span class="nc" id="L81">                    newRow = defaultValue()</span>
<span class="nc" id="L82">                }</span>
            }
        } else {
<span class="nc" id="L85">            super.setValueAt(value, rowIndex, columnIndex)</span>
        }
<span class="nc" id="L87">    }</span>

    override fun getValueAt(rowIndex: Int, columnIndex: Int): String {

<span class="nc bnc" id="L91" title="All 2 branches missed.">        return if (rowIndex &gt;= super.rowCount) {</span>
<span class="nc" id="L92">            val column = columns[columnIndex]</span>
<span class="nc bnc" id="L93"
      title="All 2 branches missed.">            val dataValue = column.getter?.invoke(newRow)</span>
<span class="nc bnc" id="L94"
      title="All 2 branches missed.">            column.mapper.mapOut(dataValue ?: &quot;&quot;)</span>
        } else {
<span class="nc" id="L96">            super.getValueAt(rowIndex, columnIndex)</span>
        }
    }
}
</pre>
<div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span>
</div>
</body>
</html>