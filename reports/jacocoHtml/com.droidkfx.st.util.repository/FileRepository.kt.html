<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
    <link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/>
    <link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/>
    <title>FileRepository.kt</title>
    <link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/>
    <script type="text/javascript" src="../jacoco-resources/prettify.js"></script>
</head>
<body onload="window['PR_TAB_WIDTH']=4;prettyPrint()">
<div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html"
                                                              class="el_session">Sessions</a></span><a
        href="../index.html" class="el_report">schwab-trader</a> &gt; <a href="index.source.html" class="el_package">com.droidkfx.st.util.repository</a>
    &gt; <span class="el_source">FileRepository.kt</span></div>
<h1>FileRepository.kt</h1>
<pre class="source lang-java linenums">package com.droidkfx.st.util.repository

import com.droidkfx.st.util.databind.ReadOnlyValueDataBinding
import io.github.oshai.kotlinlogging.KLogger
import kotlinx.serialization.ExperimentalSerializationApi
import kotlinx.serialization.json.Json
import kotlinx.serialization.json.decodeFromStream
import java.io.File

<span class="fc" id="L10">abstract class FileRepository(</span>
<span class="fc" id="L11">    protected open val logger: KLogger,</span>
<span class="pc" id="L12">    protected val rootPath: ReadOnlyValueDataBinding&lt;String&gt;</span>
) {
<span class="pc" id="L14">    protected val json = Json {</span>
<span class="fc" id="L15">        ignoreUnknownKeys = true</span>
<span class="fc" id="L16">        prettyPrint = true</span>
<span class="fc" id="L17">    }</span>

    internal inline fun &lt;reified T&gt; save(path: String, data: T) {
<span class="fc" id="L20">        logger.trace { &quot;Saving data ${data!!::class} to file: $path&quot; }</span>
<span class="fc" id="L21">        val file = getFile(path)</span>
<span class="fc" id="L22">        file.parentFile.mkdirs()</span>
<span class="fc" id="L23">        file.writeText(json.encodeToString(data))</span>
<span class="fc" id="L24">    }</span>

    internal inline fun &lt;reified T&gt; load(path: String): T? {
<span class="fc" id="L27">        logger.trace { &quot;load ${T::class.simpleName} from file: $path&quot; }</span>
<span class="fc" id="L28">        val file = getFile(path)</span>
<span class="fc" id="L29">        return try {</span>
<span class="fc" id="L30">            if (file.exists()) {</span>
<span class="fc" id="L31">                load(file)</span>
            } else {
<span class="fc" id="L33">                logger.debug { &quot;No file found at $path&quot; }</span>
<span class="fc" id="L34">                null</span>
            }
<span class="nc" id="L36">        } catch (e: Exception) {</span>
<span class="nc" id="L37">            logger.error(e) { &quot;Error loading data from file: $path&quot; }</span>
<span class="fc" id="L38">            null</span>
        }
    }

    @OptIn(ExperimentalSerializationApi::class)
    internal inline fun &lt;reified T&gt; load(file: File): T? {
<span class="fc" id="L44">        return file.inputStream().use {</span>
<span class="fc" id="L45">            json.decodeFromStream&lt;T&gt;(it)</span>
<span class="fc" id="L46">        }.also {</span>
<span class="fc" id="L47">            logger.debug { &quot;${T::class.simpleName} loaded from file: ${file.nameWithoutExtension}&quot; }</span>
<span class="fc" id="L48">        }</span>
    }

    internal inline fun &lt;reified T&gt; loadAll(): List&lt;T&gt; {
<span class="fc" id="L52">        logger.trace { &quot;loadAll ${T::class.simpleName}&quot; }</span>
<span class="fc" id="L53">        val files = File(rootPath.value).listFiles { _, name -&gt; name.endsWith(&quot;.json&quot;) }</span>
<span class="fc" id="L54">        return files?.mapNotNull { load(it) } ?: emptyList()</span>
    }

    internal fun delete(path: String) {
<span class="fc" id="L58">        val file = getFile(path)</span>
<span class="pc bpc" id="L59" title="1 of 2 branches missed.">        if (file.exists()) {</span>
<span class="fc" id="L60">            file.delete()</span>
        }
<span class="fc" id="L62">    }</span>

    internal fun deleteAll() {
<span class="fc" id="L65">        val files = File(rootPath.value).listFiles { _, name -&gt; name.endsWith(&quot;.json&quot;) }</span>
<span class="pc bpc" id="L66" title="1 of 2 branches missed.">        files?.forEach { it.delete() }</span>
<span class="fc" id="L67">    }</span>

<span class="fc" id="L69">    internal fun getFile(path: String) = File(&quot;${rootPath.value}/$path.json&quot;)</span>
}
</pre>
<div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span>
</div>
</body>
</html>